- hosts: localhost
  sudo: yes

  tasks:

    - yum: name={{ item }} state=present
      with_items:
        - fedmsg-hub
        - fedmsg-relay
        - rpm-ostree-toolbox
        - ostree
        #- fedmsg-atomic-composer

    - file: path=/srv/fedora-atomic/output
            owner=fedmsg group=fedmsg mode=755 state=directory

    - file: path=/srv/fedora-atomic/output/{{ item }}/
            owner=fedmsg group=fedmsg mode=755 state=directory
      with_items:
        - rawhide
        - f21

    - file: path=/srv/fedora-atomic/{{ item }}/tasks/treecompose
            owner=root group=root mode=655 state=directory
      with_items:
        - rawhide
        - f21

    - file: path=/srv/inbox/{{ item }}
            owner=fedmsg group=fedmsg mode=755 state=directory
      with_items:
        - rawhide
        - f21

    - git: repo=https://git.fedorahosted.org/git/fedora-atomic.git
           dest=/srv/fedora-atomic/rawhide/fedora-atomic
           update=no

    - git: repo=https://git.fedorahosted.org/git/fedora-atomic.git
           dest=/srv/fedora-atomic/f21/fedora-atomic
           version=f21
           update=no

    - service: name=atomic-compose-{{ item }} enabled=yes state=started
      with_items:
        - rawhide
        - f21

    - service: name=fedmsg-hub state=started

    - service: name=fedmsg-relay state=started

    - command: /usr/bin/ostree init --repo=/srv/fedora-atomic/output/{{ item }}/repo --mode=archive-z2
      sudo: yes
      sudo_user: fedmsg
      args:
        creates: /srv/fedora-atomic/output/{{ item }}/repo
      with_items:
       - rawhide
       - f21

    - file: src=/srv/fedora-atomic/output/{{ item }}/repo
            dest=/srv/fedora-atomic/{{ item }}/repo
            owner=fedmsg group=fedmsg state=link
      with_items:
       - rawhide
       - f21
